name: Video Process FINAL - NETFLIX AI SYNC

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'رابط الفيديو المباشر'
        required: true
      sub_url:
        description: 'رابط ملف الترجمة (أي صيغة)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install High-Performance Tools & AI Sync
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y ffmpeg fonts-liberation fonts-noto-core parallel bc jq python3-pip
          pip install ffsubsync

      - name: Download & Prepare Subtitles
        run: |
          echo "جاري تحميل الفيديو والمواد..."
          curl -L "${{ github.event.inputs.video_url }}" -o input_video
          
          SUB_URL="${{ github.event.inputs.sub_url }}"
          if [[ "$SUB_URL" == *".ass"* ]]; then EXT="ass";
          elif [[ "$SUB_URL" == *".vtt"* ]]; then EXT="vtt";
          else EXT="srt"; fi
          
          curl -L "$SUB_URL" -o "original_sub.$EXT"
          
          echo "جاري المزامنة التلقائية (AI Sync)..."
          # نستخدم اسم بسيط جداً في المجلد الحالي
          ffs input_video -i "original_sub.$EXT" -o "s.srt" || cp "original_sub.$EXT" "s.srt"
          
          # التحقق النهائي من وجود الملف
          ls -lh s.srt

      - name: Create Processing Script (The Fix)
        run: |
          # نكتب أمر المعالجة داخل ملف منفصل لتجنب مشاكل علامات التنصيص
          cat << 'EOF' > process.sh
          #!/bin/bash
          START=$1
          DUR=$2
          INDEX=$3
          
          # هنا الأمر نظيف ومباشر بدون تعقيدات parallel
          ffmpeg -hwaccel auto -ss "$START" -t "$DUR" -i input_video \
          -filter_complex "subtitles=s.srt:force_style='Fontname=Noto Sans Arabic Bold,FontSize=20,PrimaryColour=&H00FFFFFF,Outline=0,Shadow=1,Alignment=2,MarginV=30', \
          drawtext=text='FarGa':fontcolor=white@0.5:fontsize=40:fontfile=/usr/share/fonts/truetype/liberation/LiberationSans-Bold.ttf:x=30:y=30" \
          -c:v libx264 -preset ultrafast -crf 28 -c:a aac -b:a 128k "chunks/part${INDEX}.mp4"
          EOF
          
          # نعطي الصلاحية للسكربت
          chmod +x process.sh

      - name: Parallel Processing (Script Execution)
        run: |
          DURATION=$(ffprobe -v error -select_streams v:0 -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 input_video)
          PART_DURATION=$(echo "$DURATION / 4" | bc -l)
          
          mkdir chunks
          
          > starts.txt
          for i in {0..3}; do
            echo "$PART_DURATION * $i" | bc >> starts.txt
          done
          
          # الآن parallel يستدعي السكربت فقط، ويمرر له (وقت البداية) و (مدة الجزء) و (رقم الجزء)
          # {1} = start time, {#} = job number (index)
          cat starts.txt | parallel -j 4 --ungroup "./process.sh {1} $PART_DURATION {#}"

      - name: Atomic Merge
        run: |
          ls chunks/part*.mp4 | sort -V | xargs -I {} echo "file '{}'" > list.txt
          ffmpeg -f concat -safe 0 -i list.txt -c copy output.mp4

      - name: Final FTP Upload
        run: |
          FTP_USER="dsafdsafdsa"
          FTP_PASS="ti9buex2ai"
          FTP_HOST="ftp.byse.sx"
          FILE_NAME="Netflix_Done_${{ github.run_id }}.mp4"
          curl -v -T "output.mp4" --user "$FTP_USER:$FTP_PASS" "ftp://$FTP_HOST/$FILE_NAME"

      - name: Cleanup
        if: always()
        run: rm -rf chunks input_video output.mp4 s.srt original_sub.* starts.txt list.txt process.sh

name: Video Process UNIVERSAL NUCLEAR

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'ุฑุงุจุท ุงูููุฏูู ุงููุจุงุดุฑ'
        required: true
      sub_url:
        description: 'ุฑุงุจุท ููู ุงูุชุฑุฌูุฉ (ุฃู ุตูุบุฉ)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install High-Performance Tools
        run: |
          sudo apt-get update --fix-missing
          # ุชุซุจูุช ุงูุฃุฏูุงุช ูุงูุฎุทูุท ุงูุนุฑุจูุฉ ูุงููุงุชูููุฉ ุงูุนุฑูุถุฉ
          sudo apt-get install -y ffmpeg fonts-liberation fonts-noto-core parallel bc jq

      - name: Download & Prepare Subtitles
        run: |
          # 1. ุชุญููู ุงูููุฏูู ุจุฃูุตู ุณุฑุนุฉ
          echo "ุฌุงุฑู ุชุญููู ุงูููุฏูู..."
          curl -L "${{ github.event.inputs.video_url }}" -o input_video
          
          # 2. ุชุญุฏูุฏ ุตูุบุฉ ุงูุชุฑุฌูุฉ ุชููุงุฆูุงู ูุญูุธูุง ุจุงูุงูุชุฏุงุฏ ุงูุตุญูุญ
          SUB_URL="${{ github.event.inputs.sub_url }}"
          if [[ "$SUB_URL" == *".ass"* ]]; then EXT="ass";
          elif [[ "$SUB_URL" == *".vtt"* ]]; then EXT="vtt";
          else EXT="srt"; fi
          
          echo "ุชู ุชุญุฏูุฏ ุตูุบุฉ ุงูุชุฑุฌูุฉ: $EXT"
          curl -L "$SUB_URL" -o "sub.$EXT"
          echo "SUB_NAME=sub.$EXT" >> $GITHUB_ENV

      - name: Parallel Nuclear Processing
        run: |
          # 1. ุญุณุงุจ ุงููุฏุฉ ุงูุฅุฌูุงููุฉ (ุทุฑููุฉ ุณุฑูุนุฉ ุฌุฏุงู)
          DURATION=$(ffprobe -v error -select_streams v:0 -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 input_video)
          
          # ุญู ุงุญุชูุงุทู ุฅุฐุง ูุดู ffprobe ูู ูุฑุงุกุฉ ุงูู Header
          if [ -z "$DURATION" ] || [ "$DURATION" = "N/A" ]; then
            DURATION=$(ffmpeg -i input_video 2>&1 | grep "Duration" | cut -d ' ' -f 4 | sed s/,// | awk -F: '{ print ($1 * 3600) + ($2 * 60) + $3 }')
          fi
          
          echo "ูุฏุฉ ุงูููุฏูู ุงูุฅุฌูุงููุฉ: $DURATION ุซุงููุฉ"

          # 2. ุชูุณูู ุงููุฏุฉ ุนูู 4 ุฃุฌุฒุงุก ูุชูุงุฒูุฉ
          PART_DURATION=$(echo "$DURATION / 4" | bc -l)
          
          # 3. ุฅูุดุงุก ููุงุท ุงูุจุฏุงูุฉ ููู ุฌุฒุก
          echo "0" > starts.txt
          echo "$PART_DURATION" >> starts.txt
          echo "$PART_DURATION * 2" | bc >> starts.txt
          echo "$PART_DURATION * 3" | bc >> starts.txt

          # 4. ุงูุชูููุฐ ุงููููู ุงูุตุงุฑูุฎู (4 ูุญุฑูุงุช ุชุนูู ูุนุงู)
          mkdir chunks
          cat starts.txt | parallel -j 4 "ffmpeg -hwaccel auto -ss {1} -t $PART_DURATION -i input_video -filter_complex \"drawtext=text='FarGa':fontcolor=white@0.5:fontsize=40:fontfile=/usr/share/fonts/truetype/liberation/LiberationSans-Bold.ttf:x=30:y=30,subtitles=${{ env.SUB_NAME }}\" -c:v libx264 -preset ultrafast -crf 28 -c:a aac -b:a 128k chunks/part{#}.mp4"

      - name: Atomic Merge
        run: |
          # ุฏูุฌ ุงูุฃุฌุฒุงุก ุงูุฃุฑุจุนุฉ ูุญุธูุงู ุจุฏูู ุฅุนุงุฏุฉ ูุนุงูุฌุฉ
          ls chunks/part*.mp4 | sort -V | xargs -I {} echo "file '{}'" > list.txt
          ffmpeg -f concat -safe 0 -i list.txt -c copy output.mp4

      - name: Upload Result
        run: |
          echo "ุฌุงุฑู ุงูุฑูุน ุงูููุงุฆู..."
          # ุฑูุน ุงูููุฏูู ูุงูุญุตูู ุนูู ุงูุฑุงุจุท
          UPLOAD_RESPONSE=$(curl -F "file=@output.mp4" https://file.io)
          URL=$(echo $UPLOAD_RESPONSE | jq -r '.link')
          
          echo "------------------------------------------------"
          if [ "$URL" != "null" ]; then
            echo "โ ุงูุชููุช ุงูุนูููุฉ ุจูุฌุงุญ!"
            echo "๐ ุฑุงุจุท ุงูุชุญููู ุงููููู: $URL"
          else
            echo "โ ูุดู ุงูุฑูุน. ุงุณุชุฌุงุจุฉ ุงูุณูุฑูุฑ: $UPLOAD_RESPONSE"
          fi
          echo "------------------------------------------------"

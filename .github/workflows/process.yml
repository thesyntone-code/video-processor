name: Video Process FINAL - NETFLIX AI SYNC

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±'
        required: true
      sub_url:
        description: 'Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ø§Ù„ØªØ±Ø¬Ù…Ø© (Ø£ÙŠ ØµÙŠØºØ©)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install High-Performance Tools & AI Sync
        run: |
          sudo apt-get update --fix-missing
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© + Ø­Ø²Ù…Ø© Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© + python Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
          sudo apt-get install -y ffmpeg fonts-liberation fonts-noto-core parallel bc jq python3-pip
          # ØªØ«Ø¨ÙŠØª Ø£Ø¯Ø§Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©
          pip install ffsubsync

      - name: Download & Prepare Subtitles
        run: |
          echo "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯..."
          curl -L "${{ github.event.inputs.video_url }}" -o input_video
          
          SUB_URL="${{ github.event.inputs.sub_url }}"
          if [[ "$SUB_URL" == *".ass"* ]]; then EXT="ass";
          elif [[ "$SUB_URL" == *".vtt"* ]]; then EXT="vtt";
          else EXT="srt"; fi
          
          curl -L "$SUB_URL" -o "original_sub.$EXT"
          
          echo "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¬Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© (AI Sync)..."
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù…Ø¹ Ø§Ù„ØµÙˆØª Ø¨Ø¯Ù‚Ø©
          ffs input_video "original_sub.$EXT" -o "synced_sub.srt" || cp "original_sub.$EXT" "synced_sub.srt"
          
          echo "SUB_NAME=synced_sub.srt" >> $GITHUB_ENV

      - name: Parallel Processing (4-Way Optimization - Netflix Style)
        run: |
          # 1. Ø­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¯Ù‚Ø©
          DURATION=$(ffprobe -v error -select_streams v:0 -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 input_video)
          if [ -z "$DURATION" ] || [ "$DURATION" = "N/A" ]; then
            DURATION=$(ffmpeg -i input_video 2>&1 | grep "Duration" | cut -d ' ' -f 4 | sed s/,// | awk -F: '{ print ($1 * 3600) + ($2 * 60) + $3 }')
          fi
          echo "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø©: $DURATION Ø«Ø§Ù†ÙŠØ©"

          # 2. ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù€ 4 Ø£Ø¬Ø²Ø§Ø¡
          PART_DURATION=$(echo "$DURATION / 4" | bc -l)
          
          # 3. ØªÙˆÙ„ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          > starts.txt
          for i in {0..3}; do
            echo "$PART_DURATION * $i" | bc >> starts.txt
          done

          # 4. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØªÙˆØ§Ø²ÙŠØ© (Ø¯Ù…Ø¬ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø³ØªØ§ÙŠÙ„ Ù†ÙŠØªÙÙ„ÙƒØ³ + Ø§Ù„Ø´Ø¹Ø§Ø±)
          mkdir chunks
          # Ø§Ù„Ù…Ø²Ø§ÙŠØ§ Ø§Ù„Ù…Ø¶Ø§ÙØ©: Ø®Ø· Noto Sans ArabicØŒ Ø¥Ù„ØºØ§Ø¡ OutlineØŒ Ø¥Ø¶Ø§ÙØ© Shadow Ø®ÙÙŠÙØŒ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© seek_point
          cat starts.txt | parallel -j 4 --ungroup "ffmpeg -hwaccel auto -ss {1} -t $PART_DURATION -i input_video \
          -filter_complex \"subtitles=${{ env.SUB_NAME }}:force_style='Fontname=Noto Sans Arabic Bold,FontSize=20,PrimaryColour=&H00FFFFFF,Outline=0,Shadow=1,Alignment=2,MarginV=30':seek_point={1}, \
          drawtext=text='FarGa':fontcolor=white@0.5:fontsize=40:fontfile=/usr/share/fonts/truetype/liberation/LiberationSans-Bold.ttf:x=30:y=30\" \
          -c:v libx264 -preset ultrafast -crf 28 -c:a aac -b:a 128k chunks/part{#}.mp4"

      - name: Atomic Merge
        run: |
          # Ø¯Ù…Ø¬ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ù„Ø­Ø¸ÙŠØ§Ù‹ Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù…ÙŠØ²
          ls chunks/part*.mp4 | sort -V | xargs -I {} echo "file '{}'" > list.txt
          ffmpeg -f concat -safe 0 -i list.txt -c copy output.mp4

      - name: Final FTP Upload
        run: |
          echo "Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±..."
          
          FTP_USER="dsafdsafdsa"
          FTP_PASS="ti9buex2ai"
          FTP_HOST="ftp.byse.sx"
          
          FILE_NAME="video_processed_${{ github.run_id }}.mp4"

          curl -v -T "output.mp4" --user "$FTP_USER:$FTP_PASS" "ftp://$FTP_HOST/$FILE_NAME"
          
          echo "------------------------------------------------"
          echo "âœ… Ø§Ù„Ù…Ù‡Ù…Ø© ØªÙ…Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ù‡Ø± Ù…Ø¹ Ø³ØªØ§ÙŠÙ„ Ù†ÙŠØªÙÙ„ÙƒØ³ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© AI!"
          echo "ğŸ“ Ø§Ù„Ù…Ù„Ù Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† ÙÙŠ Ø³ÙŠØ±ÙØ±Ùƒ Ø¨Ø§Ø³Ù…: $FILE_NAME"
          echo "------------------------------------------------"

      - name: Cleanup
        if: always()
        run: |
          echo "ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©..."
          rm -rf chunks input_video output.mp4 sub.* original_sub.* synced_sub.srt starts.txt list.txt
